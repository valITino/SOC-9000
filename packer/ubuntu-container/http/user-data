#cloud-config
autoinstall:
  version: 1
  identity:
    hostname: containerhost
    username: labadmin
    password: "$6$soc9000salt$3lw9WQteXTDh5dcIhNazz8ZsD8q5n59ReX.Jo2x96nLbu2tH5cMHSdrJNSDIWlfKRQzQJua4JXF0CwprHLBQh0"
  ssh:
    install-server: true
    allow-pw: false
  packages:
    - open-vm-tools
    - qemu-guest-agent
  late-commands:
    # Ensure SSH + QGA are enabled in the *installed* system
    - curtin in-target --target=/target -- systemctl enable --now ssh
    - curtin in-target --target=/target -- systemctl enable --now qemu-guest-agent

    # Install your key for labadmin with correct perms (idempotent)
    - curtin in-target --target=/target -- bash -c "install -d -m 700 -o labadmin -g labadmin /home/labadmin/.ssh"
    - curtin in-target --target=/target -- bash -c "grep -qxF 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIM+7N6kIUhnys4Odq75mBe/K2XEFXWBA1ivMo97JhN86 liamo@CrHackHead' /home/labadmin/.ssh/authorized_keys 2>/dev/null || echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIM+7N6kIUhnys4Odq75mBe/K2XEFXWBA1ivMo97JhN86 liamo@CrHackHead' >> /home/labadmin/.ssh/authorized_keys"
    - curtin in-target --target=/target -- bash -c "chown -R labadmin:labadmin /home/labadmin/.ssh && chmod 600 /home/labadmin/.ssh/authorized_keys"

    # Make sudo passwordless so Packer shell provisioners won't hang
    - curtin in-target --target=/target -- bash -c "echo 'labadmin ALL=(ALL) NOPASSWD:ALL' >/etc/sudoers.d/90-labadmin && chmod 440 /etc/sudoers.d/90-labadmin"